{
  "id": "snapshot_1759119851218_rouce97v2",
  "approvalId": "approval_1759116523279_mg4ex9kt4",
  "approvalTitle": "Database Schema Completion - Design Document",
  "version": 2,
  "timestamp": "2025-09-29T04:24:11.217Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThe Database Schema Completion design extends the existing Prisma schema with comprehensive entities for Claude Code task management, execution tracking, queue state persistence, and system monitoring. This design builds upon the current User, Task, and Project models while adding sophisticated AI task execution capabilities, real-time monitoring, and enterprise-grade reliability features.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- **Prisma ORM**: Type-safe database operations with auto-generated TypeScript types\n- **PostgreSQL**: ACID compliance and data integrity with JSONB support for flexible data structures\n- **Type Safety**: Generated TypeScript interfaces provide IntelliSense and compile-time validation\n- **Migration Strategy**: Schema-first approach with reversible migrations for production safety\n\n### Project Structure (structure.md)\n- **Database Location**: `apps/backend/prisma/schema.prisma` (existing structure)\n- **Migration Files**: `apps/backend/prisma/migrations/` (following established pattern)\n- **Generated Types**: Output to `apps/backend/node_modules/.prisma/client` (existing config)\n- **Repository Pattern**: Database layer isolated from business logic\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **User Model**: Extend existing authentication and user management foundation\n- **Task Model**: Transform from basic task tracking to Claude Code AI task execution\n- **Session Management**: Build upon UserSession for process and execution tracking\n- **Project Organization**: Leverage existing project structure for task grouping\n\n### Integration Points\n- **Auth System**: Claude Code tasks inherit user ownership and permission models\n- **Task Lifecycle**: Existing task status flow enhanced with AI execution states\n- **Database Configuration**: Utilize existing PostgreSQL setup and connection management\n- **Type Generation**: Extend current Prisma type generation for new entities\n\n## Architecture\n\nThe database schema follows a domain-driven design with clear entity relationships supporting the Claude Code Task Manager's core workflows:\n\n```mermaid\ngraph TD\n    User --> ClaudeTask[Claude Code Task]\n    ClaudeTask --> TaskExecution[Task Execution]\n    TaskExecution --> ExecutionLog[Execution Log]\n    TaskExecution --> SystemMetric[System Metrics]\n\n    ClaudeTask --> QueueJob[Queue Job]\n    QueueJob --> JobAttempt[Job Attempt]\n\n    TaskExecution --> TaskResult[Task Result]\n    TaskResult --> ResultFile[Result File]\n\n    User --> UserSession\n    ClaudeTask --> Project\n\n    subgraph \"Queue Management\"\n        QueueJob\n        JobAttempt\n        QueueHealth[Queue Health]\n    end\n\n    subgraph \"Execution Tracking\"\n        TaskExecution\n        ExecutionLog\n        SystemMetric\n    end\n\n    subgraph \"Result Storage\"\n        TaskResult\n        ResultFile\n    end\n```\n\n### Modular Design Principles\n- **Single File Responsibility**: Each entity represents one business domain with clear boundaries\n- **Component Isolation**: Queue, execution, monitoring, and result domains are separate but connected\n- **Service Layer Separation**: Database entities support repository pattern implementation\n- **Utility Modularity**: Shared enums and types provide consistency across domains\n\n## Components and Interfaces\n\n### ClaudeTask Entity\n- **Purpose:** Extended task model specifically for Claude Code AI task execution\n- **Interfaces:** CRUD operations, status tracking, execution lifecycle management\n- **Dependencies:** User (creator), Project (organization), QueueJob (processing)\n- **Reuses:** Existing Task model patterns, user relationships, timestamp conventions\n\n### TaskExecution Entity\n- **Purpose:** Tracks individual execution attempts with complete lifecycle metadata\n- **Interfaces:** Real-time status updates, progress tracking, resource monitoring\n- **Dependencies:** ClaudeTask (parent), User (executor), execution environment data\n- **Reuses:** Existing timestamp patterns, relationship conventions\n\n### QueueJob & JobAttempt Entities\n- **Purpose:** Persistent queue state for BullMQ integration and retry tracking\n- **Interfaces:** Queue manipulation, retry logic, distributed processing coordination\n- **Dependencies:** ClaudeTask (work definition), execution environment configuration\n- **Reuses:** Existing enum patterns, indexing strategies, foreign key conventions\n\n### SystemMetric Entity\n- **Purpose:** Time-series system performance and health monitoring data\n- **Interfaces:** Metrics aggregation, performance analysis, trend reporting\n- **Dependencies:** TaskExecution (context), system monitoring infrastructure\n- **Reuses:** Timestamp patterns, indexing for performance queries\n\n### ExecutionLog Entity\n- **Purpose:** Structured log storage for Claude Code STDIO output and system events\n- **Interfaces:** Log streaming, search and filtering, retention management\n- **Dependencies:** TaskExecution (context), structured logging format\n- **Reuses:** JSONB patterns for flexible log data, indexing for performance\n\n## Data Models\n\n### ClaudeTask (extends existing Task concept)\n```prisma\nmodel ClaudeTask {\n  id            String      @id @default(uuid())\n  title         String\n  description   String?\n  prompt        String      // Claude Code prompt/command\n  config        Json?       // Task configuration (timeout, retry, etc.)\n  status        ClaudeTaskStatus @default(PENDING)\n  priority      TaskPriority @default(MEDIUM)\n\n  // Relationships\n  createdById   String      @map(\"created_by_id\")\n  createdBy     User        @relation(\"ClaudeTaskCreator\", fields: [createdById], references: [id])\n  projectId     String?     @map(\"project_id\")\n  project       Project?    @relation(fields: [projectId], references: [id])\n\n  // Execution tracking\n  executions    TaskExecution[]\n  queueJobs     QueueJob[]\n  results       TaskResult[]\n\n  // Metadata\n  tags          String[]\n  estimatedDuration Int?    @map(\"estimated_duration\") // seconds\n  actualDuration    Int?    @map(\"actual_duration\")    // seconds\n\n  // Timestamps\n  createdAt     DateTime    @default(now()) @map(\"created_at\")\n  updatedAt     DateTime    @updatedAt @map(\"updated_at\")\n  scheduledAt   DateTime?   @map(\"scheduled_at\")\n  startedAt     DateTime?   @map(\"started_at\")\n  completedAt   DateTime?   @map(\"completed_at\")\n\n  @@map(\"claude_tasks\")\n  @@index([status])\n  @@index([priority])\n  @@index([createdById])\n  @@index([scheduledAt])\n}\n```\n\n### TaskExecution\n```prisma\nmodel TaskExecution {\n  id              String        @id @default(uuid())\n  taskId          String        @map(\"task_id\")\n  task            ClaudeTask    @relation(fields: [taskId], references: [id], onDelete: Cascade)\n\n  // Execution metadata\n  status          ExecutionStatus @default(INITIALIZING)\n  progress        Float?        @default(0.0) // 0.0 to 1.0\n  workerId        String?       @map(\"worker_id\")\n  processId       String?       @map(\"process_id\")\n  sessionId       String?       @map(\"session_id\") // Claude Code session\n\n  // Resource tracking\n  cpuUsage        Float?        @map(\"cpu_usage\")\n  memoryUsage     Int?          @map(\"memory_usage\") // bytes\n  diskUsage       Int?          @map(\"disk_usage\")   // bytes\n\n  // Error handling\n  errorMessage    String?       @map(\"error_message\")\n  errorCode       String?       @map(\"error_code\")\n  stackTrace      String?       @map(\"stack_trace\")\n  retryCount      Int           @default(0) @map(\"retry_count\")\n\n  // Relationships\n  logs            ExecutionLog[]\n  metrics         SystemMetric[]\n\n  // Timestamps\n  createdAt       DateTime      @default(now()) @map(\"created_at\")\n  startedAt       DateTime?     @map(\"started_at\")\n  completedAt     DateTime?     @map(\"completed_at\")\n  lastHeartbeat   DateTime?     @map(\"last_heartbeat\")\n\n  @@map(\"task_executions\")\n  @@index([taskId])\n  @@index([status])\n  @@index([workerId])\n  @@index([startedAt])\n}\n```\n\n### QueueJob (BullMQ persistence)\n```prisma\nmodel QueueJob {\n  id              String        @id @default(uuid())\n  taskId          String        @map(\"task_id\")\n  task            ClaudeTask    @relation(fields: [taskId], references: [id], onDelete: Cascade)\n\n  // Queue metadata\n  queueName       String        @map(\"queue_name\")\n  jobId           String        @unique @map(\"job_id\") // BullMQ job ID\n  status          QueueJobStatus @default(WAITING)\n  priority        Int           @default(0)\n  delay           Int?          @default(0) // milliseconds\n\n  // Processing\n  attempts        JobAttempt[]\n  maxAttempts     Int           @default(3) @map(\"max_attempts\")\n  backoffType     BackoffType   @default(EXPONENTIAL) @map(\"backoff_type\")\n  backoffDelay    Int           @default(2000) @map(\"backoff_delay\") // milliseconds\n\n  // Data\n  jobData         Json          @map(\"job_data\")\n  jobOptions      Json?         @map(\"job_options\")\n  result          Json?\n\n  // Timestamps\n  createdAt       DateTime      @default(now()) @map(\"created_at\")\n  processedAt     DateTime?     @map(\"processed_at\")\n  finishedAt      DateTime?     @map(\"finished_at\")\n\n  @@map(\"queue_jobs\")\n  @@index([queueName])\n  @@index([status])\n  @@index([priority])\n  @@index([createdAt])\n}\n```\n\n### ExecutionLog\n```prisma\nmodel ExecutionLog {\n  id              String        @id @default(uuid())\n  executionId     String        @map(\"execution_id\")\n  execution       TaskExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)\n\n  // Log metadata\n  level           LogLevel      @default(INFO)\n  source          LogSource     @default(SYSTEM)\n  message         String\n  details         Json?         // Structured log data\n\n  // Context\n  component       String?       // Which component generated the log\n  operation       String?       // What operation was being performed\n  correlationId   String?       @map(\"correlation_id\")\n\n  // Timestamps\n  timestamp       DateTime      @default(now())\n\n  @@map(\"execution_logs\")\n  @@index([executionId])\n  @@index([level])\n  @@index([source])\n  @@index([timestamp])\n  @@index([correlationId])\n}\n```\n\n### SystemMetric\n```prisma\nmodel SystemMetric {\n  id              String        @id @default(uuid())\n  executionId     String?       @map(\"execution_id\")\n  execution       TaskExecution? @relation(fields: [executionId], references: [id], onDelete: Cascade)\n\n  // Metric metadata\n  metricType      MetricType\n  metricName      String        @map(\"metric_name\")\n  value           Float\n  unit            String?\n\n  // Context\n  workerId        String?       @map(\"worker_id\")\n  queueName       String?       @map(\"queue_name\")\n  tags            Json?         // Additional metric tags\n\n  // Timestamps\n  timestamp       DateTime      @default(now())\n\n  @@map(\"system_metrics\")\n  @@index([metricType])\n  @@index([metricName])\n  @@index([timestamp])\n  @@index([workerId])\n  @@index([executionId])\n}\n```\n\n### TaskResult\n```prisma\nmodel TaskResult {\n  id              String        @id @default(uuid())\n  taskId          String        @map(\"task_id\")\n  task            ClaudeTask    @relation(fields: [taskId], references: [id], onDelete: Cascade)\n\n  // Result metadata\n  status          ResultStatus  @default(SUCCESS)\n  summary         String?\n  output          Json?         // Structured output data\n\n  // File attachments\n  files           ResultFile[]\n\n  // Quality metrics\n  executionTime   Int?          @map(\"execution_time\") // milliseconds\n  tokensUsed      Int?          @map(\"tokens_used\")\n  costEstimate    Float?        @map(\"cost_estimate\")\n\n  // Timestamps\n  createdAt       DateTime      @default(now()) @map(\"created_at\")\n\n  @@map(\"task_results\")\n  @@index([taskId])\n  @@index([status])\n  @@index([createdAt])\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n1. **Database Connection Failures**\n   - **Handling:** Connection pooling with automatic retry and circuit breaker patterns\n   - **User Impact:** Graceful degradation with cached data, clear error messages\n\n2. **Migration Failures**\n   - **Handling:** Atomic transactions with automatic rollback, backup verification\n   - **User Impact:** Zero downtime deployments, data integrity preservation\n\n3. **Constraint Violations**\n   - **Handling:** Comprehensive validation at application layer before database operations\n   - **User Impact:** Clear validation error messages with field-specific guidance\n\n4. **Query Performance Issues**\n   - **Handling:** Comprehensive indexing strategy, query optimization, monitoring\n   - **User Impact:** Sub-50ms query response times maintained under load\n\n## Testing Strategy\n\n### Unit Testing\n- Entity validation and constraint testing\n- Relationship integrity verification\n- Index performance testing\n- Migration script validation\n\n### Integration Testing\n- Cross-entity relationship testing\n- Transaction boundary verification\n- Concurrent access testing\n- Database connection pooling\n\n### End-to-End Testing\n- Complete task lifecycle data flow\n- Real-time data synchronization\n- Performance testing under load\n- Data migration and backup recovery",
  "fileStats": {
    "size": 13016,
    "lines": 363,
    "lastModified": "2025-09-29T03:28:36.992Z"
  },
  "comments": []
}